name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
      after-version:
        description: 'Snapshot version after release'
        required: true

# FIXME: Entire secret keys should not be inherited, Use specific set of secrets explicitly instead.
# See this issue to learn more: https://github.com/zizmorcore/zizmor/issues/360
jobs:
  set-release-version:
    uses: AlexProgrammerDE/SoulFire/.github/workflows/set-version.yml@main
    permissions:
      contents: write
    with:
      version: ${{ inputs.version }}
    secrets: inherit

  build:
    needs: set-release-version
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          ref: ${{ github.ref }}
          persist-credentials: false
      - name: Set up JDK 25
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # 5.2.0
        with:
          java-version: '25'
          distribution: 'temurin'
          check-latest: true
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@0723195856401067f7a2779048b490ace7a47d7c # 5.0.2
      - name: Build with Gradle
        run: ./gradlew build test --stacktrace --scan

      - name: Build Changelog
        id: github_release
        uses: mikepenz/release-changelog-builder-action@6faf020194b7c8853f9e55c4fd92e40b02122a04 # 6.1.0
        with:
          mode: COMMIT
          toTag: ${{ github.ref }}
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}",
              "commit_template": "- [`#{{SHORT_MERGE_SHA}}`](https://github.com/AlexProgrammerDE/SoulFire/commit/#{{MERGE_SHA}}) #{{TITLE}}",
              "categories": [
                {
                    "title": "## ðŸš€ Features",
                    "labels": ["feat", "feature"]
                },
                {
                    "title": "## ðŸ› Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## ðŸŽï¸ Performance",
                    "labels": ["perf"]
                },
                {
                    "title": "## ðŸ— Refactor",
                    "labels": ["refactor"]
                },
                {
                    "title": "## ðŸ“ Documentation",
                    "labels": ["docs"]
                },
                {
                    "title": "## ðŸ”¨ Build",
                    "labels": ["build", "chore", "ci"]
                },
                {
                    "title": "## ðŸ’… Style",
                    "labels": ["style"]
                },
                {
                    "title": "## ðŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "title": "## ðŸ’¬ Other",
                    "labels": []
                },
                {
                  "title": "## ðŸ“¦ Dependencies",
                  "labels": ["dependencies"]
                }
              ],
              "empty_template": "no changes",
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                  "on_property": "title",
                  "target": "$1"
                }
              ],
              "custom_placeholders": [
                {
                  "name": "SHORT_MERGE_SHA",
                  "source": "MERGE_SHA",
                  "transformer": {
                    "pattern": "^([0-9a-f]{7})[0-9a-f]*$",
                    "target": "$1"
                  }
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # 2.5.0
        with:
          body: |
            ---
            > [!IMPORTANT]
            > These downloads are for users who want to host Dedicated Servers for SoulFire clients or use the CLI client of SoulFire.
            > This is not the right download if you want to use the GUI client for SoulFire, which is recommended for most users.
            > Instead you should look at the [SoulFireClient releases page](https://github.com/AlexProgrammerDE/SoulFireClient/releases).
            ---

            ${{ steps.github_release.outputs.changelog }}
          tag_name: ${{ inputs.version }}
          generate_release_notes: false
          draft: false
          prerelease: false
          target_commitish: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true
          name: SoulFire ${{ inputs.version }}
          preserve_order: true
          files: |
            dedicated-launcher/build/libs/SoulFireDedicated-${{ inputs.version }}.jar
            client-launcher/build/libs/SoulFireCLI-${{ inputs.version }}.jar
      - name: Announce new SoulFire release
        uses: tsickert/discord-webhook@b217a69502f52803de774ded2b1ab7c282e99645 # 7.0.0
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          content: <@&850705047938793503> New SoulFire version released!
          embed-title: SoulFire ${{ inputs.version }}
          embed-description: SoulFire ${{ inputs.version }} has been released! Changelog and download can be found at https://github.com/AlexProgrammerDE/SoulFire/releases/tag/${{ inputs.version }}
          embed-color: 3312063
          embed-thumbnail-url: https://soulfiremc.com/logo.png

  deploy-javadoc:
    needs: build
    uses: AlexProgrammerDE/SoulFire/.github/workflows/deploy-javadoc.yml@main
    permissions:
      contents: write
    secrets: inherit

  deploy-docker:
    needs: build
    uses: AlexProgrammerDE/SoulFire/.github/workflows/docker-deploy.yml@main
    secrets: inherit

  set-after-version:
    needs: [ deploy-javadoc, deploy-docker ]
    uses: AlexProgrammerDE/SoulFire/.github/workflows/set-version.yml@main
    permissions:
      contents: write
    with:
      version: ${{ inputs.after-version }}
    secrets: inherit
